<!DOCTYPE HTML>
<head>
<title>canvas examples</title>
<script type="text/javascript" src="lib/d3.v2.min.js"></script>
<script type="text/javascript" src="lib/underscore.js"></script>
<script type="text/javascript" src="lib/zepto.js"></script>
</head>
<body>
<div id="graphs"></div>
<script type="text/javascript">
$(function() {

var w = 720,
    h = 300,
    p = [0, 25, 15, 0],
    x = d3.scale.ordinal().rangeRoundBands([0, w - p[1] - p[3]]),
    y = d3.scale.linear().range([0, h - p[0] - p[2]]),
    z = d3.scale.ordinal().range(["darkgray", "lightblue"]),
    parse = d3.time.format("%b %e").parse,
    format = d3.time.format("%b %e");

$("#graphs").append("<canvas width="+w+" height="+h+" id='canvas'></canvas");
var canvas = document.getElementById("canvas");
var ctx = canvas.getContext('2d');

d3.json("revenue.json", function(rData) {

	var data = rData[0];
	var stacks = d3.layout.stack()(_(data).map(function(row) {
		return row;
}));

  // Compute the x-domain and y-domain.
	y.domain([0, d3.max($.map(data, function(d) {
          return d3.max(d, function(e, i) {
            return data["total"][i].y + data["gross"][i].y
          })}))*1.1]);
  x.domain(data["total"].map(function(d) { return d.x; }));

	// y axis
	y.ticks(4).forEach(function(a) {
		ctx.fillStyle = "#999";
		if (a != 0) {
			ctx.fillText(a, 0, h-p[2]-y(a)+12);
			ctx.lineWidth = .1;
			ctx.beginPath();
			ctx.moveTo(0, h-p[2]-y(a));
			ctx.lineTo(w, h-p[2]-y(a));
			ctx.stroke();
		} else {
			ctx.lineWidth = 1;
			ctx.beginPath();
			ctx.moveTo(0, h-p[2]-y(a)+1);
			ctx.lineTo(w, h-p[2]-y(a)+1);
			ctx.stroke();
		}
	});

  // Draw bars
	_(stacks).each(function(row, i) {
		_(row).each(function(d, j) {
			ctx.fillStyle = z(i);
			ctx.fillRect(p[1]+x(d.x)+1, h-p[2]-y(d.y0)-y(d.y), x.rangeBand()-1, y(d.y));
			// x axis
			if (j%7 == 0 || j==0) {
				ctx.fillStyle = "#999";
				ctx.fillText(format(new Date(d.x)), x(d.x) + x.rangeBand(), h-2);
			}
		});
	});
	});
});
</script>
